Object.defineProperty(exports, "__esModule", { value: true });
var timeloop_1 = require("../core/timeloop");
var constants_1 = require("../utils/constants");
var math_1 = require("../utils/math");
var lists_1 = require("../utils/lists");
var setup_1 = require("./setup");
var actions_1 = require("../actions");
exports.update = function (model, _data, ctx) {
    if (model.players === constants_1._) {
        setup_1.setup(model);
    }
    var isPlaying = model.state === constants_1.S_PLAYING;
    var time = model.time;
    if (!isPlaying) {
        timeloop_1.loopOff(model.id);
    }
    lists_1.all(model.players, function (player) {
        var from = player.from;
        var to = player.to;
        var isActive = isPlaying && math_1.inRange(math_1.flr(time), from, to);
        var offset = math_1.minMax((time - from) / (to - from), 0, 1);
        player.update(offset, model.rate, isActive);
    });
    ctx.trigger(actions_1.UPDATE);
};
