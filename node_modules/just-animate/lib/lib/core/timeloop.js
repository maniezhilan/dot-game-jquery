Object.defineProperty(exports, "__esModule", { value: true });
var constants_1 = require("../utils/constants");
var lists_1 = require("../utils/lists");
var store_1 = require("../store");
var actions_1 = require("../actions");
var raf = requestAnimationFrame;
var caf = cancelAnimationFrame;
var now = function () { return performance.now(); };
var active = [];
var deltas = {};
var lastHandle = constants_1._;
var lastTime = constants_1._;
function cancel() {
    caf(lastHandle);
    lastHandle = lastTime = constants_1._;
}
function update() {
    var len = active.length;
    lastTime = lastTime || now();
    if (!len) {
        cancel();
        return;
    }
    var thisTime = now();
    var delta = thisTime - lastTime;
    lastTime = thisTime;
    lastHandle = raf(update);
    for (var i = len - 1; i > -1; i--) {
        var activeId = active[i];
        deltas[activeId] += delta;
        store_1.dispatch(actions_1.TICK, activeId, delta);
    }
}
function loopOn(id) {
    if (!lists_1.includes(active, id)) {
        deltas[id] = 0;
        lists_1.push(active, id);
    }
    if (!lastHandle) {
        lastHandle = raf(update);
    }
}
exports.loopOn = loopOn;
function loopOff(id) {
    if (lists_1.remove(active, id)) {
        delete deltas[id];
    }
    if (!active.length) {
        cancel();
    }
}
exports.loopOff = loopOff;
